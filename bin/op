#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os, readline, shutil

from op.bsc import Basic
from op.dbs import last
from op.obj import Object, format, save, update
from op.prs import parse
from op.run import cfg, console, parse_cli

cfg.wd = os.path.expanduser("~/.opbot")
cfg.md = os.path.join(cfg.wd, "mod")

def docfg(event):
    from opbot.irc import Cfg
    c = Cfg()
    last(c)
    if event.prs and not event.prs.sets:
        return event.reply(format(c, skip=["username", "realname"]))
    update(c, event.prs.sets)
    save(c)
    event.reply("ok")

def cpy(event):
    if not os.path.exists(cfg.md):
        os.mkdir(cfg.md)
    fns = []
    p = os.path.join(os.getcwd(), "mod")
    nr = 0
    for fn in os.listdir(p):
        if not fn.endswith("py"):
            continue
        fns.append(fn)
    for fn in fns:
        fnn = os.path.join(cfg.md, fn)
        shutil.copy2("mod/%s" % fn, fnn)
        nr += 1
    event.reply("%s copied to %s" % (nr, p))

def set(event):
    if not event.otxt:
        event.reply(format(cfg))
        return
    last(cfg)
    parse(p, event.rest)
    update(cfg, p)
    save(cfg)
    event.reply("ok")

def main():
    parse_cli()
    if cfg.op("r"):
        cfg.wd = "/var/lib/opbot/"
        cfg.md = os.path.join(cfg.wd, "mod")
    h = Basic()
    h.fromdir(cfg.md)
    h.walk("opbot,opmod")
    h.walk(cfg.mods)
    h.add("cfg", docfg)
    if cfg.op("c"):
        h.init("csl")
        h.wait()
        return
    h.add("cpy", cpy)
    h.add("set", set)
    return h.cmd(cfg.otxt)

console(main)

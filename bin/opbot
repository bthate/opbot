#!/usr/bin/env python3
# This file is placed in the Public Domain.

import os, readline, shutil, sys

from op.dbs import last
from op.hdl import Console, Core, BusCore
from op.obj import Object, load, save
from op.run import cfg, parse_cli
from op.trm import exec
from op.utl import privileges

name = "opbot"
wd = "/var/lib/%s/" % name
md = "/var/lib/%s/mod/" % name

class Console(Console):

    def direct(self, txt):
        print(txt)

class Basic(BusCore):

    def direct(self, txt):
        print(txt)

def main():
    parse_cli()
    if not cfg.op("r"):
        cfg.wd = wd = os.path.expanduser("~/.%s" % name)
        cfg.md = md = os.path.join(cfg.wd, "mod")
    if cfg.op("r"):
        privileges(name)
    h = Core()
    h.pkgs = ["opm", name]
    h.fromdir(cfg.md)
    h.walk("opm,%s" % name)
    if cfg.op("s"):
        save(cfg)
    if cfg.op("l"):
        last(cfg)
    if cfg.txt:
        b = Basic()
        b.clone(h)
        return b.cmd(cfg.otxt)
    if cfg.op("c"):
        c = Console()
        c.clone(h)
        c.start()
    if cfg.op("i"):
        cfg.mods += ",irc"
    h.start()
    h.init(cfg.mods)
    if cfg.op("rcw"):
        h.wait()

exec(main)
